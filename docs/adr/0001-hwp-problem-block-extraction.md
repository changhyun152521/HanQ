# ADR-0001: HWP 문제 블록 추출 방식 결정

## 상태

승인됨 (2026-01)

## 맥락(Context)

이 시스템의 최종 목표는 “문항 분석”이 아니라, HWP 문서에서 **문제 단위 블록을 정확히 절단하여 원본 그대로 저장**하는 것이다.

현실적인 제약:

- HWP 내부 구조(수식/표/그림/글상자/서식/미주)는 복잡하며, 텍스트 기반 파싱으로는 원본 보존이 어렵다.
- HWP COM API는 동작이 직관적이지 않고, 일부 메서드는 환경/버전에 따라 반환값 타입이 다르다(예: `GetText()`).
- “좌표/문단 기반 선택”은 문서 레이아웃(다단, 표 등)에 영향을 크게 받으며 재현성이 낮다.

## 결정(Decision)

**마커 기반 문제 블록 추출 + 선택/저장 방식**을 채택한다.

- 문제의 경계는 `[문제시작]` ~ `[문제끝]` 마커로 정의한다.
- 마커 사이 영역을 사용자가 드래그로 선택하는 것과 유사하게 선택한다.
- 저장은 다음 우선순위를 가진다.
  1. `FileSaveBlock` / `FileSaveAs_SelBlock` (가능하면 원본 구조 보존에 유리)
  2. 복사 → 새 문서 → 붙여넣기 → 저장 (폴백)
- 무한루프/되감기 방지를 위해 “동일 문제 시작 위치 재등장 시 종료”를 적용한다.

## 대안(Alternatives Considered)

### A) 구조화 파싱(텍스트/수식/그림/표를 개별 추출)

- 장점: 검색/분석에 유리
- 단점: 요구사항과 불일치(목표는 분석이 아니라 블록 보존), 구현 비용/리스크 매우 큼

### B) 좌표(SetPos)/문단 기반 선택으로 범위 지정

- 장점: 이론적으로 단순
- 단점: 다단/표/개체 포함 문서에서 불안정, COM 동작 변동이 심함

### C) 컨트롤 열거(MoveNextCtrl) 후 컨트롤 단위 복사

- 장점: 개체 보존 가능성
- 단점: 컨트롤 경계/위치 비교가 불안정, 마커/본문 관계가 단순 텍스트 흐름과 다를 수 있음

## 결과(Consequences)

- 문제 블록은 원본 HWP 형태로 보존되므로, UI에서 “원본 보기/검증” 흐름이 중요해진다.
- 검색은 `content_text`(보조 필드)에 의존한다.
- 마커 계약(문서 작성 규칙)이 품질에 직접 영향이 있다.
- HWP COM API의 변동성 때문에, 로그/검증(특히 클립보드 기반 검증)이 필수적이다.

## 참고(Links)

- 구현 가이드: `docs/hwp-parsing-guide.md`
- 핵심 파일: `processors/hwp/hwp_reader.py`, `processors/hwp/problem_splitter.py`
