# HWP 문제 블록 파싱 가이드 (마커 기반)

이 문서는 **HWP 문서에서 `[문제시작]` ~ `[문제끝]` 사이를 “분석”하지 않고, 사람이 드래그해서 복사-붙여넣기한 것과 동일한 형태로 “문제 블록”을 통째로 보존**하기 위한 구현/디버깅 메모입니다.

---

## 목표(정의)

- **Problem은 구조화된 텍스트가 아니라 “HWP 문제 블록 원본”**입니다.
- 추출 기준은 **마커 문자열**입니다.
  - 시작: `[문제시작]`
  - 끝: `[문제끝]`
- 수식/그림/표/서식/글상자 등이 포함되어도 **블록 자체가 보존**되어야 합니다.
- `content_text`는 검색/미리보기용 보조 데이터입니다.
  - **중요**: HWP의 미주/각주(주석) 때문에 “정답/해설이 본문보다 먼저” 섞여 나오는 케이스가 있어,
    `content_text`는 “원본 블록을 그대로 텍스트화”가 아니라 **미리보기 목적에 맞게(주석 제거 등) 가공**될 수 있습니다.

---

## 관련 코드 위치(중요 파일)

- `processors/hwp/hwp_reader.py`
  - HWP COM 제어, 마커 탐색, 선택/복사/저장, GetText 정규화 등
- `processors/hwp/problem_splitter.py`
  - “여러 문제” 반복 추출 루프(진행/중복 방지 포함)
- `processors/hwp/hwp_controller.py`
  - 파싱 흐름 상위 오케스트레이션
- `database/repositories/problem_repository.py`
  - GridFS 포함 저장/조회
- `utils/hwp_restore.py`
  - GridFS에서 원본 HWP 복원/열기(검증용)
- `services/problem/problem_service.py`
  - “미리보기 일괄생성”에서 원본 문제 HWP(1문제짜리)를 임시 파일로 복원한 뒤 `content_text`를 채움

---

## 문서 작성 규칙(마커 계약)

안정적인 파싱을 위해, HWP 문서에서 아래 규칙을 지키는 것을 권장합니다.

- **마커는 정확히 동일 문자열**로 넣습니다(공백/변형 금지).
  - `[문제시작]`, `[문제끝]`
- 가능하면 **마커는 독립된 줄(독립 문단)**에 둡니다.
- 문제 본문은 마커 사이에 위치합니다.
- `[문제끝]`은 반드시 존재해야 합니다(누락 시 파싱 오류/루프 이상 가능).

---

## 파싱 알고리즘 개요(현재 구현)

1. HWP를 COM으로 연다.
2. 현재 커서 이후에서 `[문제시작]`을 찾는다.
3. `[문제시작]` 다음 문단(문제 본문 시작)으로 이동한다.
4. `[문제끝]`을 찾는다.
5. `[문제끝]`의 **시작 위치(마커 문자열 직전)**를 “선택 종료 경계”로 산출한다.
6. 시작점에서 `Select` → 끝점까지 이동하며 `ExtendSel`로 선택 확장.
7. 선택된 블록을 저장한다.
   - 1순위: `FileSaveBlock` / `FileSaveAs_SelBlock`
   - 2순위(폴백): 복사 → 새 문서 → 붙여넣기 → 저장
8. `[문제끝]` 마커 뒤로 커서를 이동하고 다음 문제로 반복한다.
9. 문서 끝에서 `RepeatFind`가 wrap-around(처음으로 되감기) 할 수 있으므로,
   - **같은 문제 시작 위치가 재등장하면 루프 종료**(무한루프 방지)

---

## `content_text`(미리보기/검색용 텍스트) 생성 전략

### 왜 파싱 단계에서 `content_text`를 만들지 않나?

- 목표가 “블록 원본 보존”이기 때문에, 파싱 단계에서 텍스트까지 뽑으면
  - **속도가 크게 느려질 수 있고**
  - HWP의 주석(미주/각주) 편집 상태/텍스트 평탄화 방식 때문에 **품질 이슈(정답이 앞에 붙는 등)**가 발생할 수 있습니다.
- 그래서 파싱(DB 생성)은 **최대한 빠르게**, `content_text`는 **필요할 때만** 생성하는 “지연 생성” 전략을 사용합니다.

### 설정(config)

- `config/config.json`
  - `hwp.extract_text_during_parse`: `false` 권장
    - `false`: DB 생성(파싱) 빠름, 대신 `content_text`는 빈 값일 수 있음
    - `true`: 파싱 중 텍스트도 같이 생성(환경에 따라 느려질 수 있음)

---

## 미리보기 일괄생성(누락된 `content_text` 채우기)

### 동작 개요

1. DB에서 문제 목록을 가져온다.
2. 각 문제의 “1문제짜리 HWP 원본”을 GridFS에서 바이트로 읽는다.
3. 임시 `.hwp` 파일로 저장 후 열기
4. **미리보기용 전처리(주석 삭제 / 본문 포커스 복귀)**
5. 텍스트 추출(2단계 폴백)
   - `GetText()` 반복 호출로 본문 텍스트를 최대한 수집
   - 실패/빈 값이면 `SelectAll` → `Copy` → 클립보드 텍스트 fallback
6. `content_text`를 DB에 업데이트
7. 임시 파일 삭제

관련 코드:

- `services/problem/problem_service.py`: `generate_missing_previews(...)`
- `processors/hwp/hwp_reader.py`: `get_text_from_document()`

---

## 주석(미주/각주) 때문에 미리보기에 “정답/해설이 먼저” 나오는 문제

### 왜 이런 일이 생기나?

HWP는 환경/문서 구조에 따라 “전체 선택(Ctrl+A) → 복사(Ctrl+C)” 결과 텍스트를 만들 때
**본문 + 주석(미주/각주) 텍스트를 섞어서** 내보내며, 이때 주석 텍스트가 **앞쪽에 붙는** 케이스가 있습니다.
그래서 “1문제짜리 HWP 블록”이어도 Notepad에 붙여넣으면 정답이 먼저 나오는 현상이 생깁니다.

### 해결 방식(현재 구현)

- 원본(HWP 블록)은 절대 수정하지 않습니다.
- 미리보기 생성 시에만 임시 복사본에서 **주석을 삭제한 뒤** 텍스트를 뽑습니다.
- 주석 삭제는 사용자 제공 매크로 동작을 `HAction`으로 재현하는 방식입니다.
  - `Goto(HGotoE)`로 주석 위치로 이동 → `MoveSelRight` → `Delete`
  - 운영 전제: “문제당 주석 1개” → 1회만 시도하여 “더 이상 없음”류 팝업을 최소화

관련 코드:

- `processors/hwp/hwp_reader.py`: `_delete_notes_via_macro(max_iters=1)`

---

## HWP 팝업(찾기 끝/없음, 저장 여부 등) 무인화/억제

자동화 중 뜨는 팝업은 크게 2종류가 있습니다.

### 1) MessageBox 계열(일부는 `SetMessageBoxMode`로 억제 가능)

- `SetMessageBoxMode`를 임시로 설정하여 OK/Cancel/No 등을 자동 선택합니다.
- `RepeatFind`는 `IgnoreMessage=1`도 함께 사용합니다.

### 2) “찾기” 대화상자 등(일부 버전에서는 `SetMessageBoxMode`가 안 먹을 수 있음)

- 특히 미리보기 생성 과정에서 `Goto(HGotoE)`/주석 삭제 매크로가 트리거가 되어
  `"문서의 끝까지 찾았습니다"`, `"더 이상 찾는 내용이 없습니다"`, `"저장하시겠습니까"` 같은 창이 뜨는 케이스가 있습니다.
- 이 경우를 대비해, **미리보기 생성 구간에서만** 윈도우 레벨로 다이얼로그(#32770)를 감시하고
  버튼(확인/취소/저장 안 함 등)을 자동 클릭하는 “안전장치”를 사용합니다.

관련 코드:

- `processors/hwp/hwp_reader.py`: `_HwpPopupAutoCloser`, `_auto_close_hwp_popups(...)`

---

## 핵심 디버깅 포인트 / 삽질 포인트(중요)

### 1) `GetText()`는 문자열이 아닐 수 있다 (매우 중요)

HWP COM의 `GetText()`는 환경에 따라 `str`이 아니라 **튜플**을 반환할 수 있습니다.

- 예: `(101, '')`
- 이 경우 `len(GetText()) == 2`가 되어 “선택 텍스트 길이=2” 같은 오판이 발생합니다.

따라서 **반드시 GetText 결과를 정규화**해서 실제 텍스트만 추출해야 합니다.

### 2) 클립보드 길이는 “선택이 실제로 잡혔는지”의 가장 강한 증거

선택이 제대로 되었는지 판단이 애매하면,

- 선택 직후 `Copy`
- 클립보드에서 텍스트를 읽어 길이/미리보기를 확인

이 방식이 가장 확실합니다(특히 HWP 창을 숨기는 설정이 있을 때).

### 3) 원본 문서를 다시 `Open()` 하면 커서/상태가 초기화될 수 있다

복사-붙여넣기 방식으로 새 문서를 만들었다가 닫은 뒤,
원본을 `Open()`으로 다시 열면 **커서가 초기화되어 같은 문제를 반복**할 수 있습니다.

따라서 원본 복귀는 가급적 `Activate()`로 처리합니다.

### 4) `RepeatFind`는 문서 끝에서 처음으로 되감기(wrap-around)할 수 있다

문제 5개인데 6번째에서 1번째 마커를 다시 찾는 현상이 생길 수 있습니다.

해결:

- “문제 시작 위치”를 `seen` 집합으로 기록
- 동일 시작 위치 재등장 시 루프 종료

### 5) `[문제끝]` 마커가 결과에 붙는 현상

이 현상은 보통 아래 중 하나입니다.

- 선택 종료 경계가 “마커 시작”이 아니라 “마커 끝”으로 잡힘
- HWP 선택 끝점 포함/미포함 규칙 차이
- 블록 저장이 문자 단위가 아니라 문단/컨트롤 단위로 포함

대응:

- 마커 선택에서 `MoveSelBegin/MoveSelEnd`로 **시작/끝 좌표를 둘 다 읽고 보정**
- 필요 시 종료 경계를 한 칸 이동(-1)하는 안전장치 유지

### 6) 미주/각주(footnote)가 복사-붙여넣기 폴백에서 누락될 수 있음

가능하면 `FileSaveBlock` 계열이 보존에 유리할 수 있습니다.
다만 환경에 따라 액션이 실행되어도 파일이 생성되지 않는 케이스가 있어,
파일 생성 여부 체크 후 폴백이 필요합니다.

---

## 트러블슈팅 체크리스트(현상 → 확인)

- **선택 텍스트 길이가 항상 2로 찍힘**
  - GetText가 튜플인지 확인(정규화 적용 여부)
- **파일이 계속 열리거나 무한루프**
  - wrap-around 감지(같은 시작 위치 재등장 시 종료) 적용 여부
  - 원본 문서 재오픈(Open) 여부(Activate로 복귀 권장)
- **`FileSaveBlock`이 성공처럼 보이는데 파일이 안 생김**
  - `os.path.exists(output_path)`로 실제 생성 확인
  - 실패 시 복사-붙여넣기 폴백
- **`[문제끝]`이 결과에 붙음**
  - 종료 경계가 “마커 시작”으로 잡히는지 확인
  - 종료 경계 -1 안전장치가 실제로 적용되는지 확인
- **미리보기 일괄생성에서 팝업이 계속 떠서 멈춤**
  - `processors/hwp/hwp_reader.py`의 `_HwpPopupAutoCloser` 적용 여부 확인
  - `pywin32` 설치 여부(특히 `win32gui`, `win32con`) 확인
- **미리보기가 정답/해설부터 시작함**
  - 주석 삭제가 임시 복사본에서 수행되는지 확인(`_delete_notes_via_macro`)
  - “문제당 주석 1개” 운영 전제가 문서에 맞는지 확인(문서가 예외라면 정책 조정 필요)

---

## 실행/검증 방법(개발자용)

- 의존성 설치:

```bash
pip install -r requirements.txt
```

- 실행:

```bash
python main.py
```

- 검증:
  - 파싱된 문제 상세 화면에서 “원본 HWP 보기”로 복원된 블록이 문제 단위로 정확한지 확인
  - 특히 수식/표/그림/미주 포함 여부 확인
